# .github/workflows/AutoMerge.yml
name: Auto-merge PRs & cleanup merged branches

on:
  workflow_dispatch:
  schedule:
    # Runs daily. Adjust as desired.
    - cron: "17 06 * * *"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: automerge-cleanup
  cancel-in-progress: false

jobs:
  automerge_and_cleanup:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ github.token }}
      MERGE_METHOD: squash
      INCLUDE_DRAFTS: "false"
      KEEP_BRANCH_REGEX: '^(main|master|develop|dev|release|staging|production|gh-pages)$'

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Auto-merge all open PRs (enable auto-merge + delete branch after merge)
        shell: bash
        run: |
          set -euo pipefail

          case "${MERGE_METHOD}" in
            squash) merge_flag="--squash" ;;
            merge)  merge_flag="--merge" ;;
            rebase) merge_flag="--rebase" ;;
            *) echo "MERGE_METHOD must be squash|merge|rebase (got: ${MERGE_METHOD})" >&2; exit 1 ;;
          esac

          echo "Finding open PRs..."
          mapfile -t prs < <(gh pr list --state open --limit 200 --json number,isDraft --jq '.[] | "\(.number) \(.isDraft)"')

          if (( ${#prs[@]} == 0 )); then
            echo "No open PRs found."
            exit 0
          fi

          for row in "${prs[@]}"; do
            pr_number="${row%% *}"
            is_draft="${row##* }"

            if [[ "${INCLUDE_DRAFTS}" != "true" && "${is_draft}" == "true" ]]; then
              echo "Skipping draft PR #${pr_number}"
              continue
            fi

            echo "Enabling auto-merge for PR #${pr_number} (${MERGE_METHOD}) and deleting branch after merge..."
            if ! gh pr merge "${pr_number}" ${merge_flag} --auto --delete-branch; then
              echo "WARN: Could not enable auto-merge for PR #${pr_number} (conflicts, missing checks/reviews, or restrictions)."
            fi
          done

      - name: "Cleanup: delete branches that are already merged"
        shell: bash
        run: |
          set -euo pipefail

          default_branch="$(gh repo view --json defaultBranchRefName -q '.defaultBranchRefName')"
          echo "Default branch: ${default_branch}"

          git fetch origin --prune --tags
          git fetch origin "+refs/heads/*:refs/remotes/origin/*" --prune

          mapfile -t branches < <(gh api "repos/${GITHUB_REPOSITORY}/branches" --paginate -q '.[].name')

          if (( ${#branches[@]} == 0 )); then
            echo "No branches returned by GitHub API."
            exit 0
          fi

          for branch in "${branches[@]}"; do
            if [[ "${branch}" == "${default_branch}" ]]; then
              continue
            fi

            if [[ "${branch}" =~ ${KEEP_BRANCH_REGEX} ]]; then
              echo "Keeping branch (matches KEEP_BRANCH_REGEX): ${branch}"
              continue
            fi

            open_prs="$(gh pr list --state open --head "${branch}" --json number --jq 'length' || echo 0)"
            if [[ "${open_prs}" != "0" ]]; then
              echo "Keeping branch (has open PR): ${branch}"
              continue
            fi

            merged_by_pr="0"
            merged_by_git="0"

            merged_prs="$(gh pr list --state merged --head "${branch}" --base "${default_branch}" --json number --jq 'length' || echo 0)"
            if [[ "${merged_prs}" != "0" ]]; then
              merged_by_pr="1"
            fi

            if git show-ref --verify --quiet "refs/remotes/origin/${branch}"; then
              if git merge-base --is-ancestor "origin/${branch}" "origin/${default_branch}"; then
                merged_by_git="1"
              fi
            fi

            if [[ "${merged_by_pr}" == "1" || "${merged_by_git}" == "1" ]]; then
              echo "Deleting merged branch: ${branch}"
              git push origin --delete "${branch}" || echo "WARN: Failed to delete ${branch} (protected or already deleted)."
            else
              echo "Not deleting (not detected as merged): ${branch}"
            fi
          done
